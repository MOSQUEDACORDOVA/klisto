<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
  crossorigin="anonymous"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>


<script>
  function select_hora(hora_desde, hora_hasta){
    document.getElementById('h_desde').value= hora_desde  
    document.getElementById('h_hasta').value= hora_hasta  
    console.log(hora_desde+'-'+hora_hasta)
  }

  $(function () {
  $('.lugar_serv').on('click', (e)=>{
    let valor = e.target.value;
    console.log(valor)

    if(valor == 'Personal'){
        if ($('#domicilio_servicio_propio').is(':visible')){
         $('#domicilio_servicio_propio').attr('style', 'display:none')
      }
      if ($('#servicio_tercero').is(':visible')){
         $('#servicio_tercero').attr('style', 'display:none')
        $('.lugar_serv_propio').prop('checked', false);
        return $('#servicio_propio').removeAttr('style')
      }
      $('.lugar_serv_propio').prop('checked', false);
        $('#servicio_propio').removeAttr('style')
    }else{
       if ($('#domicilio_servicio_propio').is(':visible')){
         $('#domicilio_servicio_propio').attr('style', 'display:none')
      }
      if ($('#servicio_propio').is(':visible')){
         $('#servicio_propio').attr('style', 'display:none')
        return $('#servicio_tercero').removeAttr('style')
      }
        $('#servicio_tercero').removeAttr('style') 
    }
  })
    $('.lugar_serv_propio').on('click', (e)=>{
    let valor = e.target.value;
    console.log(valor)

    if(valor == 'A Domicilio'){
      
        $('#domicilio_servicio_propio').removeAttr('style')
    }else{
      if ($('#domicilio_servicio_propio').is(':visible')){
         $('#domicilio_servicio_propio').attr('style', 'display:none')
      }
    }
  })
//





$('.sucursales_check:checked').each(function() {
   var id_suc = $(this).val()
        $('.sucur'+id_suc).show()
        let suc_actual=$('#sucursales_p').text()
        console.log($(this).text())
        $('#sucursales_p').text($('#suc'+id_suc).text()+'/'+suc_actual+'' )
      console.log("hola")
    }
);
      $('.btn_submit_preview').on('click',()=>{
        if($('#preview_publicacion').is(':visible')){
        $('#crear_publicacion').show()
        $('#preview_publicacion').hide()
      }
        $('.btn_submit').click()})

    $('.preview').on('click', () => {
        if($('#preview_publicacion').is(':visible')){
        $('#preview_publicacion').hide()
        $('#crear_publicacion').show()
      }else{
      $('#preview_publicacion').show()
      $('#crear_publicacion').hide()
      $('#titulo_preview').text($('#titulo').val())
      $('#precio_preview').text('S/' + $('#precio').val())
      $('#descripcion_preview').text($('#descripcion').val())
      $('#condiciones_preview').text($('#condiciones').val())
      $('#desde_preview').text($('#desde').val())
      $('#hasta_preview').text($('#hasta').val())
      $('#preparacion_p').text($('#preparacion').val()+' min') 
      $('#ejecucion_p').text($('#ejecucion').val()+' min') 
       if($('.editar_public')){
          $('#img_preview').attr('src', "../assets/img_up/" + $('#imagen1').val())
       $('#img1').attr('src', "../assets/img_up/" + $('#imagen2').val())
      $('#img2').attr('src', "../assets/img_up/" + $('#imagen3').val())
      $('#img3').attr('src', "../assets/img_up/" + $('#imagen4').val())
      $('#img4').attr('src', "../assets/img_up/" + $('#imagen5').val())
      }else{
         $('#img_preview').attr('src', "assets/img_up/" + $('#imagen1').val())
        $('#img1').attr('src', "assets/img_up/" + $('#imagen2').val())
      $('#img2').attr('src', "assets/img_up/" + $('#imagen3').val())
      $('#img3').attr('src', "assets/img_up/" + $('#imagen4').val())
      $('#img4').attr('src', "assets/img_up/" + $('#imagen5').val())
      }
      }


    })
    $('.sucursales_check').on('change', (e) => {
      var id_suc = e.target.classList.item(1)
      if($('.sucur'+id_suc).is(':visible')){
        $('.sucur'+id_suc).hide()
      }else{
        $('.sucur'+id_suc).show()
        let suc_actual=$('#sucursales_p').text()
        console.log(suc_actual)
        $('#sucursales_p').text($('#suc'+id_suc).text()+'/'+suc_actual+'' )
      }

    })


$("input[name=empleado]").click(function () {    
        console.log("La edad seleccionada es: " + $('input:radio[name=empleado]:checked').val());
       $('#id_encargado').val($(this).val());
    });


// SCRIP BASE DE DATOS
var fecha_agenda_ar =[]
var empleado_oc =[]
var hora_desde_arr =[]
var hora_hasta_arr =[]
$('#fecha_ag').on('change', ()=>{
  if($('#id_encargado').val() ==""){
  alert ('Debe seleccionar un empleado para avanzar')
  return
}
let fecha = $('#fecha_ag').val()
const data = new FormData();
data.append("fecha", fecha);
$.ajax({
      url: '/consulta_bd',
      type: 'POST',
      data: data,
      cache: false,
      contentType: false,
      processData: false,
      /*xhr: function () {        
          var xhr = $.ajaxSettings.xhr();
          xhr.upload.onprogress = function (event) {
              var perc = Math.round((event.loaded / event.total) * 100);
             // $("#nombreArchivoCalendario1").text(inputFile.name);
             
              $("#progressBar1").text(perc + '%');
              $("#progressBar1").css('width', perc + '%');
          };
          return xhr;
      },
      beforeSend: function (xhr) {
        displayLoading()
          $("#progressBar1").text('0%');
          $("#progressBar1").css('width', '0%');
      },*/
      success: function (data, textStatus, jqXHR)
      {  
        
        fecha_agenda_ar.splice(0, fecha_agenda_ar.length);
hora_desde_arr.splice(0, hora_desde_arr.length);
hora_hasta_arr.splice(0, hora_hasta_arr.length);
        let id_empleado = $('#id_encargado').val()
       for (let i = 0; i < data.fechas.length; i++) {
         if (data.fechas[i].encargadoId == id_empleado){
           fecha_agenda_ar.push(data.fechas[i]);
           hora_desde_arr.push(data.fechas[i].hora_cita_desde)
           hora_hasta_arr.push(data.fechas[i].hora_cita_hasta)
         }  
  
} 
let desde = ($('#desde_preview').text()).split(':')
let hasta = ($('#hasta_preview').text()).split(':')
let preparacion_p = $('#preparacion_p').text()
let ejecucion_p = $('#ejecucion_p').text()
let tiempo = parseInt(preparacion_p)+parseInt(ejecucion_p)
let diferencia = parseInt(hasta[0])-parseInt(desde[0])
let hora_ = ($('#desde_preview').text()).replace(':', ''); 
let h =parseInt(desde[0])-1
let sumah = "";
var hora_d = "";
var parent = document.getElementById("disponibles");
console.log(hora_desde_arr)
  console.log(hora_hasta_arr)
 document.getElementById('disponibles').innerHTML='';
for (let i = 0; i < diferencia; i++) {

h++
hora_d = moment(h + "00", "hmm").format('hh:mm');
// console.log(hora_d)
sumah = (moment(h + "00", "hmm").add(tiempo, 'm').format('hh:mm'))
let res = (moment(h + "00", "hmm").subtract(tiempo, 'm').format('hh:mm'))
// console.log(sumah)
  var found = fecha_agenda_ar.find(element => element.hora_cita_desde == hora_d);
   if (found == null ){
var input = document.createElement("a");
var div = document.createElement("div");
input.innerHTML = hora_d + '-'+sumah+'<br>';
input.setAttribute('class', 'select_hora');
input.setAttribute('onclick', 'select_hora("'+hora_d+'", "'+sumah+'")');

div.appendChild(input);

parent.appendChild(div);

  }else{
    console.log('hora ocupada')
  }

}
      },
      error: function (jqXHR, textStatus) { 
        console.log('error:'+ jqXHR)
      }
  });
})



  })
</script>
{{#if msg}}
<label id="msgs">{{msg}}</label>


{{/if}}

<div class="page-container" {{#if publicaciones_landing}}style='padding-left: 0;'{{/if}}>
  <div class="main-content" {{#if publicaciones_landing}}style='padding-top: 15px;'{{/if}}>
    <div class="section__content section__content--p30">
      <main>
        <div class="container-fluid">
          <div class="row" {{#if publicaciones_landing}}style='display: none;'{{/if}}>
            <div class="col-md-12">
              <div class="overview-wrap" >
                <h2 class="title-1">
                  <div class="float-right"><a href="/dash_cliente" id="volver_publicaciones"> Volver </a></div>
                </h2>
              </div>
            </div>
          </div>

          {{#if publicacion_activa}}

          <div class="container" id="preview_publicacion" >
            <div class="row">
              <div class="col">
                <div class="card-blank" style="margin-left: 15px; margin-bottom: 10px;">
                  <div class="card-body">
                    <img src="../assets/img_up/{{#fotoPrincipalPublicacion publicacion.fotos}}{{/fotoPrincipalPublicacion}}" alt="..."
                      class="img-thumbnail" id="img_preview" style="height: 400px;">
                  </div>
                </div>

              </div>
              <div class="col">
                <div class="card-blank">
                  <div class="card-body">
                    <h5 class="card-title" id="titulo_preview" style="text-align: left;"></h5>
                    <h6 class="card-subtitle mb-2 " id="precio_preview" style="text-align: left;"></h6>
                    <h6 class="card-subtitle mb-2 " style="text-align: left;">Descripcion</h6>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">{{publicacion.descripcion}}</p>
                    <h6 class="card-title" style="text-align: left;">Condiciones</h6>
                    <p class="card-text" id="condiciones_preview" style="text-align: left;">{{publicacion.condiciones}}</p>
                  </div>
                </div>
              </div>

            </div>

            <div class="row">
              <div class="col">
                <div class="card-blank">
                  <div class="card-body">
                    <h5 class="card-title" id="titulo_preview" style="text-align: left;">Información del anunciante</h5>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;"><strong>{{usuario.name}}</strong></p>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">{{principal.direccion}}</p>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">Tiempo de preparación: Preparación:<span id="preparacion_p">{{publicacion.preparacion}} min.</span> y Ejecución:<span id="ejecucion_p">{{publicacion.ejecucion}} min.</span> </p>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">Disponible en:<br>
                      {{#sucursalesdisponibles publicacion.sucursales sucursales}}{{/sucursalesdisponibles}}
                    <span id="sucursales_p"></span></p>
                     <p class="card-text" id="descripcion_preview" style="text-align: left;">Empleados en:<br>
                     {{#empleados_disponibles publicacion.empleados encargados}}{{/empleados_disponibles}}
                    <span id="sucursales_p"></span></p>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">Abierto de: <span
                        id="desde_preview">{{publicacion.horario_desde}}</span> hasta: <span id="hasta_preview">{{publicacion.horario_hasta}}</span></p>
                    <p class="card-text" id="descripcion_preview" style="text-align: left;">Calificación</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="row" style=" margin-bottom: 60px;">
              <div class="col">


                
                <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
                  <div class="carousel-inner">
                    <div class="carousel-item active">
                      <img class="imgpreview" src="../assets/img_up/{{#fotoPublicacion1 publicacion.fotos}}{{/fotoPublicacion1}}"
                        alt="First slide" style="width: auto; height: 150px;" id="img1">
                    </div>
                    <div class="carousel-item">
                      <img class="imgpreview" src="../assets/img_up/{{#fotoPublicacion2 publicacion.fotos}}{{/fotoPublicacion2}}"
                        alt="Second slide" style="width: auto; height: 150px;" id="img2">
                    </div>
                    <div class="carousel-item">
                      <img class="imgpreview" src="../assets/img_up/{{#fotoPublicacion3 publicacion.fotos}}{{/fotoPublicacion3}}"
                        alt="Third slide" style="width: auto; height: 150px;" id="img3">
                    </div>
                    <div class="carousel-item">
                      <img class="imgpreview" src="../assets/img_up/{{#fotoPublicacion4 publicacion.fotos}}{{/fotoPublicacion4}}"
                        alt="Third slide" style="width: auto; height: 150px;" id="img4">
                    </div>
                  </div>
                   <div class="carousel-item">
                      <img class="imgpreview" src="../assets/img_up/{{#fotoPublicacion5 publicacion.fotos}}{{/fotoPublicacion5}}"
                        alt="Third slide" style="width: auto; height: 150px;" id="img4">
                    </div>
                  </div>
                  
                  <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                  </a>
                  <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                  </a>
                </div>
                
              </div>
              <style>
                input:invalid+span:after {
  position: absolute;
  content: '✖';
  padding-left: 5px;
}

input:valid+span:after {
  position: absolute;
  content: '✓';
  padding-left: 5px;
}
              </style>
             <!-- <form method="post"  action="/pasarela_publicacion">-->
               <form method="post"  action="/guardar_agenda">
                <input type="text" id="id_publicacion" class="" name='id_publicacion' hidden value="{{publicacion.id}}">
                  <div class="col">
                    <div class="form-row">
                      <div class="col">
                        <label for="formGroupExampleInput">Agenda</label> 
                        <input type="date" class="form-control" placeholder="Desde" name="fecha" id="fecha_ag">
                      </div>
                    </div>
                     <div class="form-row">
                      <div class="" id="disponibles">
                       
                      </div>
                      <div class="form-row">
                      <div class="col">
                        <label for="formGroupExampleInput">Datos del Servicio</label> 
                        <input type="radio" class="form-control lugar_serv" value="Personal" name="lugar_servicio" id="personal"><label>Personal</label>
                        <input type="radio" class="form-control lugar_serv" value="A Tercero" name="lugar_servicio" id="atercero"><label>A Tercero</label>
                        <br>
                      <div  id="servicio_tercero" style="display: none;">
                         <label for="formGroupExampleInput">Datos del Servicio</label> 
                        <input type="text" class="form-control" placeholder="Nombre" name="nombre_del_tercero" id="">
                        <input type="text" class="form-control" placeholder="Teléfono" name="telefono_tercero" id="">
                        <input type="text" class="form-control" placeholder="Dirección" name="direccion_tercero" id="">
                      </div>
                       

                      </div>
                    </div>
                    
                       <div class="col" id="servicio_propio" style="display: none;">
                        <label for="formGroupExampleInput">Datos del Servicio Propio</label> 
                        <input type="radio" class="form-control lugar_serv_propio" value="A Domicilio" name="lugar_serv_propio" id=""><label>A Domicilio</label>
                        <input type="radio" class="form-control lugar_serv_propio" value="En Local" name="lugar_serv_propio" id=""><label>En Local</label>
                      </div>
                       <div  id="domicilio_servicio_propio" style="display: none;">
                         <label for="formGroupExampleInput">Datos del Servicio</label> 
                         <input type="text" class="form-control" placeholder="Telefono de contacto" name="telefono_contacto" id="">
                        <input type="text" class="form-control" placeholder="Dirección" name="direccion_propio_otra" id="">
                      </div>
                    </div>
                  </div>
                  <input type="text" class="form-control" placeholder="Hasta" name="h_desde"  id= "h_desde" hidden><span class="validity"></span>
                        <input type="text" class="form-control" placeholder="Hasta" name="h_hasta" id="h_hasta" hidden>
                      <input type="text" class="form-control" name="id_encargado" id="id_encargado" hidden>
                 <button type="submit" class="btn btn-primary ">Comprar</button>
              </form>
             
            </div>
          </div>
          {{/if}}
        </div>
      </main>
    </div>

  </div>
</div>